
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python interface for Imaging Data Commons">
      
      
      
        <link rel="canonical" href="https://github.com/ImagingDataCommons/idc-index/api/">
      
      
        <link rel="prev" href="..">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.6">
    
    
      
        <title>API - idc-index docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#idc_index.index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="idc-index docs" class="md-header__button md-logo" aria-label="idc-index docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            idc-index docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/ImagingDataCommons/idc-index" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ImagingDataCommons/idc-index
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="idc-index docs" class="md-nav__button md-logo" aria-label="idc-index docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    idc-index docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ImagingDataCommons/idc-index" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ImagingDataCommons/idc-index
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    API
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#idc_index.index" class="md-nav__link">
    <span class="md-ellipsis">
      index
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient" class="md-nav__link">
    <span class="md-ellipsis">
      IDCClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IDCClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_dicom_series" class="md-nav__link">
    <span class="md-ellipsis">
      download_dicom_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_from_manifest" class="md-nav__link">
    <span class="md-ellipsis">
      download_from_manifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_from_selection" class="md-nav__link">
    <span class="md-ellipsis">
      download_from_selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_dicom_studies" class="md-nav__link">
    <span class="md-ellipsis">
      get_dicom_studies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_series_file_URLs" class="md-nav__link">
    <span class="md-ellipsis">
      get_series_file_URLs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_viewer_URL" class="md-nav__link">
    <span class="md-ellipsis">
      get_viewer_URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.sql_query" class="md-nav__link">
    <span class="md-ellipsis">
      sql_query
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#idc_index.index" class="md-nav__link">
    <span class="md-ellipsis">
      index
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient" class="md-nav__link">
    <span class="md-ellipsis">
      IDCClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IDCClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_dicom_series" class="md-nav__link">
    <span class="md-ellipsis">
      download_dicom_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_from_manifest" class="md-nav__link">
    <span class="md-ellipsis">
      download_from_manifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.download_from_selection" class="md-nav__link">
    <span class="md-ellipsis">
      download_from_selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_dicom_studies" class="md-nav__link">
    <span class="md-ellipsis">
      get_dicom_studies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_series_file_URLs" class="md-nav__link">
    <span class="md-ellipsis">
      get_series_file_URLs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.get_viewer_URL" class="md-nav__link">
    <span class="md-ellipsis">
      get_viewer_URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idc_index.index.IDCClient.sql_query" class="md-nav__link">
    <span class="md-ellipsis">
      sql_query
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>API</h1>

<div class="doc doc-object doc-module">



<a id="idc_index.index"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="idc_index.index.IDCClient" class="doc doc-heading">
          <code>IDCClient</code>


</h2>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>idc_index/index.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">IDCClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;idc_index.csv.zip&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Index file not found. Downloading latest version of the index file. This will take a minute or so.&quot;</span><span class="p">)</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">latest_idc_index_csv_url</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Index file downloaded.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;collection_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;Modality&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
            <span class="s1">&#39;series_size_MB&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;s5cmd.exe&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;s5cmd&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;s5cmd&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">):</span>
            <span class="c1"># try to check if there is a s5cmd executable in the path</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;s5cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span> <span class="o">=</span> <span class="s1">&#39;s5cmd&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;s5cmd executable not found. Please install s5cmd from https://github.com/peak/s5cmd#installation&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Print after successful reading of index</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully read the index and located s5cmd.&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_filter_by_collection_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">collection_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;collection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">collection_id</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;collection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">collection_id</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_df</span>

    <span class="k">def</span> <span class="nf">_filter_by_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">patient_id</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_df</span>

    <span class="k">def</span> <span class="nf">_filter_by_dicom_study_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dicom_study_uid</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dicom_study_uid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">dicom_study_uid</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dicom_study_uid</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_df</span>

    <span class="k">def</span> <span class="nf">_filter_by_dicom_series_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dicom_series_uid</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dicom_series_uid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">dicom_series_uid</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dicom_series_uid</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_df</span>

    <span class="k">def</span> <span class="nf">get_idc_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">idc_version</span><span class="p">;</span>

    <span class="k">def</span> <span class="nf">get_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">unique_collections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;collection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">unique_collections</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_series_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">seriesInstanceUID</span><span class="p">][</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">get_patients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_id</span><span class="p">,</span> <span class="n">outputFormat</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;collection_id must be a string or list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputFormat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span><span class="s2">&quot;df&quot;</span><span class="p">,</span><span class="s2">&quot;list&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;outputFormat must be either &#39;dict&#39;, &#39;df&#39;, or &#39;list&quot;</span><span class="p">)</span>

        <span class="n">patient_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_collection_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">collection_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">patient_df</span><span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patient_df</span><span class="o">=</span><span class="n">patient_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection_id&#39;</span><span class="p">:</span><span class="s1">&#39;Collection&#39;</span><span class="p">})</span>
            <span class="n">patient_df</span> <span class="o">=</span> <span class="n">patient_df</span><span class="p">[[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientSex&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientAge&#39;</span><span class="p">]]</span>
            <span class="n">patient_df</span> <span class="o">=</span> <span class="n">patient_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;PatientID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                <span class="s1">&#39;PatientSex&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                <span class="s1">&#39;PatientAge&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">patient_df</span> <span class="o">=</span> <span class="n">patient_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
            <span class="c1"># Convert DataFrame to a list of dictionaries for the API-like response</span>
            <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">patient_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">patient_df</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Get patient response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span> <span class="nf">get_dicom_studies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patientId</span><span class="p">,</span> <span class="n">outputFormat</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns one row per distinct value of StudyInstanceUID</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;patientId must be a string or list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputFormat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span><span class="s2">&quot;df&quot;</span><span class="p">,</span><span class="s2">&quot;list&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;outputFormat must be either &#39;dict&#39; or &#39;df&#39; or &#39;list&#39;&quot;</span><span class="p">)</span>

        <span class="n">studies_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">patientId</span><span class="p">)</span> 


        <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>   
            <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_size_MB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
            <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_series_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
            <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_instance_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;instanceCount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

            <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;patient_study_series_count&#39;</span><span class="p">:</span> <span class="s1">&#39;SeriesCount&#39;</span><span class="p">})</span>

            <span class="c1">#patient_study_df = patient_study_df[[&#39;PatientID&#39;, &#39;PatientSex&#39;, &#39;Collection&#39;, &#39;PatientAge&#39;, &#39;StudyInstanceUID&#39;, &#39;StudyDate&#39;, &#39;StudyDescription&#39;, &#39;patient_study_size_MB&#39;, &#39;SeriesCount&#39;, &#39;patient_study_instance_count&#39;]]</span>
            <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="p">[[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesCount&#39;</span><span class="p">]]</span>
            <span class="c1"># Group by &#39;StudyInstanceUID&#39;</span>
            <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                <span class="s1">&#39;StudyDate&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                <span class="s1">&#39;StudyDescription&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                <span class="s1">&#39;SeriesCount&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span><span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesCount&#39;</span><span class="p">])</span>


            <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Get patient study response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">get_dicom_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outputFormat</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;studyInstanceUID must be a string or list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputFormat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span><span class="s2">&quot;df&quot;</span><span class="p">,</span><span class="s2">&quot;list&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;outputFormat must be either &#39;dict&#39; or &#39;df&#39; or &#39;list&#39;&quot;</span><span class="p">)</span>

        <span class="n">series_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_dicom_study_uid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">series_df</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">series_df</span> <span class="o">=</span> <span class="n">series_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;instanceCount&#39;</span><span class="p">:</span> <span class="s1">&#39;instance_count&#39;</span><span class="p">})</span>
            <span class="n">series_df</span><span class="p">[</span><span class="s1">&#39;ImageCount&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">series_df</span> <span class="o">=</span> <span class="n">series_df</span><span class="p">[[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;Modality&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesDate&#39;</span><span class="p">,</span> <span class="s1">&#39;Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;BodyPartExamined&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;Manufacturer&#39;</span><span class="p">,</span> <span class="s1">&#39;ManufacturerModelName&#39;</span><span class="p">,</span> <span class="s1">&#39;series_size_MB&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;instance_count&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageCount&#39;</span><span class="p">]]</span>

            <span class="n">series_df</span> <span class="o">=</span> <span class="n">series_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Modality&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesDate&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesDescription&#39;</span><span class="p">,</span><span class="s1">&#39;BodyPartExamined&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">])</span>
            <span class="c1"># Convert DataFrame to a list of dictionaries for the API-like response</span>
            <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">series_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">series_df</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Get series response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">download_dicom_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the files corresponding to the seriesInstanceUID to the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            seriesInstanceUID: string containing the value of DICOM SeriesInstanceUID to filter by</span>
<span class="sd">            downloadDir: string containing the path to the directory to download the files to</span>
<span class="sd">            dry_run: boolean indicating if the download should be a dry run (default: False)</span>
<span class="sd">            quiet: boolean indicating if the output should be suppressed (default: True)</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seriesInstanceUID</span><span class="p">][</span><span class="s1">&#39;series_aws_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;AWS Bucket Location: &#39;</span><span class="o">+</span><span class="n">series_url</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">aws_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-progress&#39;</span><span class="p">,</span>
            <span class="n">series_url</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded files to </span><span class="si">{</span><span class="n">downloadDir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download files.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_series_file_URLs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URLs of the files corresponding to the DICOM instances in a given SeriesInstanceUID.</span>

<span class="sd">        Args:</span>
<span class="sd">            SeriesInstanceUID: string containing the value of DICOM SeriesInstanceUID to filter by</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of strings containing the AWS S3 URLs of the files corresponding to the SeriesInstanceUID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Query to get the S3 URL</span>
        <span class="n">s3url_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT</span>
<span class="s1">          series_aws_url</span>
<span class="s1">        FROM</span>
<span class="s1">          index</span>
<span class="s1">        WHERE</span>
<span class="s1">          SeriesInstanceUID=&#39;</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">s3url_query_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">s3url_query</span><span class="p">)</span>
        <span class="n">s3_url</span> <span class="o">=</span> <span class="n">s3url_query_df</span><span class="o">.</span><span class="n">series_aws_url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Remove the last character from the S3 URL</span>
        <span class="n">s3_url</span> <span class="o">=</span> <span class="n">s3_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Run the s5cmd ls command and capture its output</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;s5cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">s3_url</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c1"># Parse the output to get the file names</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s3_url</span><span class="o">+</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">file_names</span>

    <span class="k">def</span> <span class="nf">get_viewer_URL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">viewer_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URL of the IDC viewer for the given series or study in IDC based on</span>
<span class="sd">        the provided SeriesInstanceUID or StudyInstanceUID. If StudyInstanceUID is not provided,</span>
<span class="sd">        it will be automatically deduced. If viewer_selector is not provided, default viewers</span>
<span class="sd">        will be used (OHIF v2 for radiology modalities, and Slim for SM).</span>

<span class="sd">        This function will validate the provided SeriesInstanceUID or StudyInstanceUID against IDC</span>
<span class="sd">        index to ensure that the series or study is available in IDC.</span>

<span class="sd">        Args:</span>
<span class="sd">            SeriesInstanceUID: string containing the value of DICOM SeriesInstanceUID for a series</span>
<span class="sd">            available in IDC</span>

<span class="sd">            StudyInstanceUID: string containing the value of DICOM SeriesInstanceUID for a series</span>
<span class="sd">            available in IDC</span>

<span class="sd">            viewer_selector: string containing the name of the viewer to use. Must be one of the following:</span>
<span class="sd">            ohif_v2, ohif_v2, or slim. If not provided, default viewers will be used. </span>

<span class="sd">        Returns:</span>
<span class="sd">            string containing the IDC viewer URL for the given SeriesInstanceUID</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either SeriesInstanceUID or StudyInstanceUID, or both, must be provided.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SeriesInstanceUID not found in IDC index.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">studyInstanceUID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StudyInstanceUID not found in IDC index.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">viewer_selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">viewer_selector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ohif_v2&#39;</span><span class="p">,</span> <span class="s1">&#39;ohif_v3&#39;</span><span class="p">,</span> <span class="s1">&#39;slim&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;viewer_selector must be one of &#39;ohif_v2&#39;, &#39;ohif_v3&#39; or &#39;slim&#39;.&quot;</span><span class="p">)</span>

        <span class="n">modality</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT</span>
<span class="s1">                DISTINCT(StudyInstanceUID),</span>
<span class="s1">                Modality</span>
<span class="s1">            FROM</span>
<span class="s1">                index</span>
<span class="s1">            WHERE</span>
<span class="s1">                SeriesInstanceUID=&#39;</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">            &#39;&#39;&#39;</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">studyInstanceUID</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">modality</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">Modality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT</span>
<span class="s1">                DISTINCT(Modality)</span>
<span class="s1">            FROM</span>
<span class="s1">                index</span>
<span class="s1">            WHERE</span>
<span class="s1">                StudyInstanceUID=&#39;</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">            &#39;&#39;&#39;</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">modality</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">Modality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">viewer_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;SM&#39;</span> <span class="ow">in</span> <span class="n">modality</span><span class="p">:</span>
                <span class="n">viewer_selector</span> <span class="o">=</span> <span class="s1">&#39;slim&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">viewer_selector</span> <span class="o">=</span> <span class="s1">&#39;ohif_v2&#39;</span>

        <span class="k">if</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;ohif_v2&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/viewer/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/viewer/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">?SeriesInstanceUID=</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;ohif_v3&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/v3/viewer/?StudyInstanceUIDs=</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/v3/viewer/?StudyInstanceUIDs=</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&amp;SeriesInstanceUID=</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;volview&quot;</span><span class="p">:</span>
            <span class="c1"># TODO! Not implemented yet</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;slim&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/slim/studies/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/slim/studies/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">/series/</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">viewer_url</span>

    <span class="k">def</span> <span class="nf">download_from_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collection_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patientId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download the files corresponding to the selection. The filtering will be applied in sequence (but does it matter?) by first selecting the collection(s), followed by</span>
<span class="sd">        patient(s), study(studies) and series. If no filtering is applied, all the files will be downloaded.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_id: string or list of strings containing the values of collection_id to filter by</span>
<span class="sd">            patientId: string or list of strings containing the values of PatientID to filter by</span>
<span class="sd">            studyInstanceUID: string or list of strings containing the values of DICOM StudyInstanceUID to filter by</span>
<span class="sd">            seriesInstanceUID: string or list of strings containing the values of DICOM SeriesInstanceUID to filter by</span>
<span class="sd">            downloadDir: string containing the path to the directory to download the files to</span>

<span class="sd">        Returns:</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If any of the parameters are not of the expected type</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">collection_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;collection_id must be a string or list of strings&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patientId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;patientId must be a string or list of strings&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;studyInstanceUID must be a string or list of strings&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;seriesInstanceUID must be a string or list of strings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">collection_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_collection_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">collection_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="n">patientId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_patient_id</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">patientId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_dicom_study_uid</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_dicom_series_uid</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">)</span>

        <span class="n">total_size</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total size of files to download: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total free space on disk: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span><span class="o">.</span><span class="n">f_bsize</span> <span class="o">*</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dry run. Not downloading files. Rerun with dry_run=False to download the files.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Download the files</span>
        <span class="c1"># make temporary file to store the list of files to download</span>
        <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">,</span> <span class="s1">&#39;download_manifest.s5cmd&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp --show-progress &quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;series_aws_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">downloadDir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_from_manifest</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_from_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifestFile</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download the files corresponding to the manifest file from IDC. The manifest file should be a text file with each line containing the s5cmd command to download the file. The URLs in the file must correspond to those in the AWS buckets!</span>

<span class="sd">        Args:</span>
<span class="sd">            manifest_file: string containing the path to the manifest file</span>
<span class="sd">            downloadDir: string containing the path to the directory to download the files to</span>

<span class="sd">        Returns:</span>

<span class="sd">        Raises:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">downloadDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Download directory does not exist.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Manifest does not exist.&quot;</span><span class="p">)</span>

        <span class="c1"># open manifest_file and read the first line that does not start from &#39;#&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(s3:\/\/.*)\/\*&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the bucket URL in the first line of the manifest file.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">folder_url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">aws_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">folder_url</span><span class="p">]</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># check if output starts with ERROR</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Folder not available in AWS. Checking in Google Cloud Storage.&quot;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">gcp_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">folder_url</span><span class="p">]</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Folder not available in GCP. Manifest appears to be invalid.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endpoint_to_use</span> <span class="o">=</span> <span class="n">gcp_endpoint_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">endpoint_to_use</span> <span class="o">=</span> <span class="n">aws_endpoint_url</span>

        <span class="c1"># create an updated manifest to include the specified destination directory</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_manifest_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;s3:\/\/.*\*&quot;</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">folder_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the bucket URL in the first line of the manifest file.&quot;</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="n">folder_url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">temp_manifest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; cp &#39;</span><span class="o">+</span><span class="n">folder_url</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">downloadDir</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">endpoint_to_use</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">temp_manifest_file</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded files to </span><span class="si">{</span><span class="n">downloadDir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Downloaded files: &quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download files.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute SQL query against the table in the index using duckdb.</span>

<span class="sd">        Args:</span>
<span class="sd">            sql_query: string containing the SQL query to execute. The table name to use in the FROM clause is &#39;index&#39; (without quotes).</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas dataframe containing the results of the query</span>

<span class="sd">        Raises:</span>
<span class="sd">            any exception that duckdb.query() raises</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.download_dicom_series" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">download_dicom_series</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Download the files corresponding to the seriesInstanceUID to the specified directory.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>seriesInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the value of DICOM SeriesInstanceUID to filter by</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>downloadDir</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the path to the directory to download the files to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dry_run</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>boolean indicating if the download should be a dry run (default: False)</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>quiet</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>boolean indicating if the output should be suppressed (default: True)</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:</p>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download_dicom_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the files corresponding to the seriesInstanceUID to the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        seriesInstanceUID: string containing the value of DICOM SeriesInstanceUID to filter by</span>
<span class="sd">        downloadDir: string containing the path to the directory to download the files to</span>
<span class="sd">        dry_run: boolean indicating if the download should be a dry run (default: False)</span>
<span class="sd">        quiet: boolean indicating if the output should be suppressed (default: True)</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">series_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">seriesInstanceUID</span><span class="p">][</span><span class="s1">&#39;series_aws_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;AWS Bucket Location: &#39;</span><span class="o">+</span><span class="n">series_url</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">aws_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-progress&#39;</span><span class="p">,</span>
        <span class="n">series_url</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded files to </span><span class="si">{</span><span class="n">downloadDir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download files.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.download_from_manifest" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">download_from_manifest</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Download the files corresponding to the manifest file from IDC. The manifest file should be a text file with each line containing the s5cmd command to download the file. The URLs in the file must correspond to those in the AWS buckets!</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>manifest_file</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the path to the manifest file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>downloadDir</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the path to the directory to download the files to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:</p>
<p>Raises:</p>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download_from_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifestFile</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the files corresponding to the manifest file from IDC. The manifest file should be a text file with each line containing the s5cmd command to download the file. The URLs in the file must correspond to those in the AWS buckets!</span>

<span class="sd">    Args:</span>
<span class="sd">        manifest_file: string containing the path to the manifest file</span>
<span class="sd">        downloadDir: string containing the path to the directory to download the files to</span>

<span class="sd">    Returns:</span>

<span class="sd">    Raises:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">downloadDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Download directory does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Manifest does not exist.&quot;</span><span class="p">)</span>

    <span class="c1"># open manifest_file and read the first line that does not start from &#39;#&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">break</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(s3:\/\/.*)\/\*&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the bucket URL in the first line of the manifest file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">folder_url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">aws_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">folder_url</span><span class="p">]</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># check if output starts with ERROR</span>
    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Folder not available in AWS. Checking in Google Cloud Storage.&quot;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">gcp_endpoint_url</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">folder_url</span><span class="p">]</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Folder not available in GCP. Manifest appears to be invalid.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">endpoint_to_use</span> <span class="o">=</span> <span class="n">gcp_endpoint_url</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">endpoint_to_use</span> <span class="o">=</span> <span class="n">aws_endpoint_url</span>

    <span class="c1"># create an updated manifest to include the specified destination directory</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_manifest_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifestFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;s3:\/\/.*\*&quot;</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">folder_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find the bucket URL in the first line of the manifest file.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">folder_url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">temp_manifest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; cp &#39;</span><span class="o">+</span><span class="n">folder_url</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">downloadDir</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s5cmdPath</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;--endpoint-url&#39;</span><span class="p">,</span> <span class="n">endpoint_to_use</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">temp_manifest_file</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded files to </span><span class="si">{</span><span class="n">downloadDir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Downloaded files: &quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download files.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.download_from_selection" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">download_from_selection</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collection_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patientId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Download the files corresponding to the selection. The filtering will be applied in sequence (but does it matter?) by first selecting the collection(s), followed by
patient(s), study(studies) and series. If no filtering is applied, all the files will be downloaded.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>collection_id</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string or list of strings containing the values of collection_id to filter by</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>patientId</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string or list of strings containing the values of PatientID to filter by</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>studyInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string or list of strings containing the values of DICOM StudyInstanceUID to filter by</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>seriesInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string or list of strings containing the values of DICOM SeriesInstanceUID to filter by</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>downloadDir</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the path to the directory to download the files to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:</p>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>TypeError</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If any of the parameters are not of the expected type</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download_from_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collection_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patientId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the files corresponding to the selection. The filtering will be applied in sequence (but does it matter?) by first selecting the collection(s), followed by</span>
<span class="sd">    patient(s), study(studies) and series. If no filtering is applied, all the files will be downloaded.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_id: string or list of strings containing the values of collection_id to filter by</span>
<span class="sd">        patientId: string or list of strings containing the values of PatientID to filter by</span>
<span class="sd">        studyInstanceUID: string or list of strings containing the values of DICOM StudyInstanceUID to filter by</span>
<span class="sd">        seriesInstanceUID: string or list of strings containing the values of DICOM SeriesInstanceUID to filter by</span>
<span class="sd">        downloadDir: string containing the path to the directory to download the files to</span>

<span class="sd">    Returns:</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If any of the parameters are not of the expected type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">collection_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;collection_id must be a string or list of strings&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">patientId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;patientId must be a string or list of strings&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">studyInstanceUID</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;studyInstanceUID must be a string or list of strings&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;seriesInstanceUID must be a string or list of strings&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">collection_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_collection_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">collection_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>

    <span class="k">if</span> <span class="n">patientId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_patient_id</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">patientId</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_dicom_study_uid</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_dicom_series_uid</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">)</span>

    <span class="n">total_size</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total size of files to download: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total free space on disk: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span><span class="o">.</span><span class="n">f_bsize</span> <span class="o">*</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">)</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;GB&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dry run. Not downloading files. Rerun with dry_run=False to download the files.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Download the files</span>
    <span class="c1"># make temporary file to store the list of files to download</span>
    <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">downloadDir</span><span class="p">,</span> <span class="s1">&#39;download_manifest.s5cmd&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp --show-progress &quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;series_aws_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">downloadDir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">download_from_manifest</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="n">downloadDir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.get_dicom_studies" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_dicom_studies</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="n">outputFormat</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>returns one row per distinct value of StudyInstanceUID</p>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dicom_studies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patientId</span><span class="p">,</span> <span class="n">outputFormat</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns one row per distinct value of StudyInstanceUID</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patientId</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;patientId must be a string or list of strings&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputFormat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span><span class="s2">&quot;df&quot;</span><span class="p">,</span><span class="s2">&quot;list&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;outputFormat must be either &#39;dict&#39; or &#39;df&#39; or &#39;list&#39;&quot;</span><span class="p">)</span>

    <span class="n">studies_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">patientId</span><span class="p">)</span> 


    <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>   
        <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_size_MB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;series_size_MB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_series_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="n">studies_df</span><span class="p">[</span><span class="s1">&#39;patient_study_instance_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">])[</span><span class="s1">&#39;instanceCount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;collection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;patient_study_series_count&#39;</span><span class="p">:</span> <span class="s1">&#39;SeriesCount&#39;</span><span class="p">})</span>

        <span class="c1">#patient_study_df = patient_study_df[[&#39;PatientID&#39;, &#39;PatientSex&#39;, &#39;Collection&#39;, &#39;PatientAge&#39;, &#39;StudyInstanceUID&#39;, &#39;StudyDate&#39;, &#39;StudyDescription&#39;, &#39;patient_study_size_MB&#39;, &#39;SeriesCount&#39;, &#39;patient_study_instance_count&#39;]]</span>
        <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="p">[[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesCount&#39;</span><span class="p">]]</span>
        <span class="c1"># Group by &#39;StudyInstanceUID&#39;</span>
        <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;StudyDate&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
            <span class="s1">&#39;StudyDescription&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
            <span class="s1">&#39;SeriesCount&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">studies_df</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span><span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesCount&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">outputFormat</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">studies_df</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Get patient study response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.get_series_file_URLs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_series_file_URLs</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the URLs of the files corresponding to the DICOM instances in a given SeriesInstanceUID.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>SeriesInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the value of DICOM SeriesInstanceUID to filter by</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of strings containing the AWS S3 URLs of the files corresponding to the SeriesInstanceUID</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_series_file_URLs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URLs of the files corresponding to the DICOM instances in a given SeriesInstanceUID.</span>

<span class="sd">    Args:</span>
<span class="sd">        SeriesInstanceUID: string containing the value of DICOM SeriesInstanceUID to filter by</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of strings containing the AWS S3 URLs of the files corresponding to the SeriesInstanceUID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Query to get the S3 URL</span>
    <span class="n">s3url_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    SELECT</span>
<span class="s1">      series_aws_url</span>
<span class="s1">    FROM</span>
<span class="s1">      index</span>
<span class="s1">    WHERE</span>
<span class="s1">      SeriesInstanceUID=&#39;</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">s3url_query_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">s3url_query</span><span class="p">)</span>
    <span class="n">s3_url</span> <span class="o">=</span> <span class="n">s3url_query_df</span><span class="o">.</span><span class="n">series_aws_url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Remove the last character from the S3 URL</span>
    <span class="n">s3_url</span> <span class="o">=</span> <span class="n">s3_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Run the s5cmd ls command and capture its output</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;s5cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-sign-request&#39;</span><span class="p">,</span> <span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">s3_url</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="c1"># Parse the output to get the file names</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s3_url</span><span class="o">+</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">file_names</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.get_viewer_URL" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_viewer_URL</span><span class="p">(</span><span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">viewer_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the URL of the IDC viewer for the given series or study in IDC based on
the provided SeriesInstanceUID or StudyInstanceUID. If StudyInstanceUID is not provided,
it will be automatically deduced. If viewer_selector is not provided, default viewers
will be used (OHIF v2 for radiology modalities, and Slim for SM).</p>
<p>This function will validate the provided SeriesInstanceUID or StudyInstanceUID against IDC
index to ensure that the series or study is available in IDC.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>SeriesInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the value of DICOM SeriesInstanceUID for a series</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>StudyInstanceUID</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the value of DICOM SeriesInstanceUID for a series</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>viewer_selector</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the name of the viewer to use. Must be one of the following:</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the IDC viewer URL for the given SeriesInstanceUID</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_viewer_URL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesInstanceUID</span><span class="p">,</span> <span class="n">studyInstanceUID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">viewer_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URL of the IDC viewer for the given series or study in IDC based on</span>
<span class="sd">    the provided SeriesInstanceUID or StudyInstanceUID. If StudyInstanceUID is not provided,</span>
<span class="sd">    it will be automatically deduced. If viewer_selector is not provided, default viewers</span>
<span class="sd">    will be used (OHIF v2 for radiology modalities, and Slim for SM).</span>

<span class="sd">    This function will validate the provided SeriesInstanceUID or StudyInstanceUID against IDC</span>
<span class="sd">    index to ensure that the series or study is available in IDC.</span>

<span class="sd">    Args:</span>
<span class="sd">        SeriesInstanceUID: string containing the value of DICOM SeriesInstanceUID for a series</span>
<span class="sd">        available in IDC</span>

<span class="sd">        StudyInstanceUID: string containing the value of DICOM SeriesInstanceUID for a series</span>
<span class="sd">        available in IDC</span>

<span class="sd">        viewer_selector: string containing the name of the viewer to use. Must be one of the following:</span>
<span class="sd">        ohif_v2, ohif_v2, or slim. If not provided, default viewers will be used. </span>

<span class="sd">    Returns:</span>
<span class="sd">        string containing the IDC viewer URL for the given SeriesInstanceUID</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either SeriesInstanceUID or StudyInstanceUID, or both, must be provided.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SeriesInstanceUID not found in IDC index.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">studyInstanceUID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StudyInstanceUID not found in IDC index.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">viewer_selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">viewer_selector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ohif_v2&#39;</span><span class="p">,</span> <span class="s1">&#39;ohif_v3&#39;</span><span class="p">,</span> <span class="s1">&#39;slim&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;viewer_selector must be one of &#39;ohif_v2&#39;, &#39;ohif_v3&#39; or &#39;slim&#39;.&quot;</span><span class="p">)</span>

    <span class="n">modality</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">studyInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT</span>
<span class="s1">            DISTINCT(StudyInstanceUID),</span>
<span class="s1">            Modality</span>
<span class="s1">        FROM</span>
<span class="s1">            index</span>
<span class="s1">        WHERE</span>
<span class="s1">            SeriesInstanceUID=&#39;</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">studyInstanceUID</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">modality</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">Modality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT</span>
<span class="s1">            DISTINCT(Modality)</span>
<span class="s1">        FROM</span>
<span class="s1">            index</span>
<span class="s1">        WHERE</span>
<span class="s1">            StudyInstanceUID=&#39;</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">modality</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">Modality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">viewer_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;SM&#39;</span> <span class="ow">in</span> <span class="n">modality</span><span class="p">:</span>
            <span class="n">viewer_selector</span> <span class="o">=</span> <span class="s1">&#39;slim&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer_selector</span> <span class="o">=</span> <span class="s1">&#39;ohif_v2&#39;</span>

    <span class="k">if</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;ohif_v2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/viewer/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/viewer/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">?SeriesInstanceUID=</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;ohif_v3&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/v3/viewer/?StudyInstanceUIDs=</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/v3/viewer/?StudyInstanceUIDs=</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&amp;SeriesInstanceUID=</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;volview&quot;</span><span class="p">:</span>
        <span class="c1"># TODO! Not implemented yet</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">viewer_selector</span> <span class="o">==</span> <span class="s2">&quot;slim&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seriesInstanceUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/slim/studies/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://viewer.imaging.datacommons.cancer.gov/slim/studies/</span><span class="si">{</span><span class="n">studyInstanceUID</span><span class="si">}</span><span class="s1">/series/</span><span class="si">{</span><span class="n">seriesInstanceUID</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">viewer_url</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="idc_index.index.IDCClient.sql_query" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">sql_query</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Execute SQL query against the table in the index using duckdb.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sql_query</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string containing the SQL query to execute. The table name to use in the FROM clause is 'index' (without quotes).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pandas dataframe containing the results of the query</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>idc_index/index.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SQL query against the table in the index using duckdb.</span>

<span class="sd">    Args:</span>
<span class="sd">        sql_query: string containing the SQL query to execute. The table name to use in the FROM clause is &#39;index&#39; (without quotes).</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas dataframe containing the results of the query</span>

<span class="sd">    Raises:</span>
<span class="sd">        any exception that duckdb.query() raises</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>




  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.e1c3ead8.min.js"></script>
      
    
  </body>
</html>